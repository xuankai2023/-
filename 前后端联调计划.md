# 前后端联调计划文档

## 一、项目架构概述

### 技术栈
- **前端**: React 19 + TypeScript + Vite + Ant Design
- **前端端口**: 8000
- **后端端口**: 8080
- **HTTP 客户端**: Axios
- **状态管理**: Zustand

### 当前状态
- 前端已配置 Axios 请求拦截器和响应拦截器
- 支持 JWT Token 认证
- 使用环境变量管理 API 基础地址

## 二、连接配置方案

### 方案一：开发环境使用 Vite 代理（推荐）

**优点**:
- 解决跨域问题
- 开发时无需修改代码
- 支持热更新

**配置步骤**:
1. 在 `vite.config.ts` 中配置代理
2. 前端请求使用相对路径 `/api`
3. Vite 自动将请求转发到 `http://localhost:8080`

**请求流程**:
```
前端请求: /api/users
    ↓
Vite 代理转发
    ↓
后端接收: http://localhost:8080/api/users
```

### 方案二：使用环境变量直接连接

**优点**:
- 配置简单
- 适合生产环境

**配置步骤**:
1. 创建 `.env.development` 文件
2. 设置 `VITE_API_BASE_URL=http://localhost:8080`
3. 前端直接请求后端地址

**请求流程**:
```
前端请求: http://localhost:8080/api/users
    ↓
直接请求后端
    ↓
后端接收: http://localhost:8080/api/users
```

## 三、详细配置步骤

### 步骤 1: 配置 Vite 代理（开发环境）

在 `vite.config.ts` 的 `server` 配置中添加 `proxy`:

```typescript
server: {
    port: 8083,
    open: true,
    proxy: {
        '/api': {
            target: 'http://localhost:8083',
            changeOrigin: true,
            rewrite: (path) => path.replace(/^\/api/, '/api'),
            // 如果需要，可以配置 WebSocket
            ws: true,
        }
    }
}
```

### 步骤 2: 创建环境变量文件

创建 `.env.development`:
```env
# 开发环境 API 地址
VITE_API_BASE_URL=/api
```

创建 `.env.production`:
```env
# 生产环境 API 地址（根据实际部署地址修改）
VITE_API_BASE_URL=http://your-production-api.com
```

### 步骤 3: 更新 request.ts

确保 `src/utils/request.ts` 中的 baseURL 配置正确:

```typescript
const request: AxiosInstance = axios.create({
    baseURL: import.meta.env.VITE_API_BASE_URL || '/api',
    timeout: 10000,
    headers: {
        'Content-Type': 'application/json',
    },
});
```

### 步骤 4: 修复 Token 格式

在 `request.ts` 的请求拦截器中，确保 Token 格式正确:

```typescript
config.headers.Authorization = `Bearer ${token}`; // 注意 Bearer 和 token 之间有空格
```

## 四、接口联调流程

### 4.1 准备工作

1. **启动后端服务**
   ```bash
   # 确保后端服务运行在 8080 端口
   # 检查后端是否正常启动
   curl http://localhost:8080/health
   ```

2. **启动前端服务**
   ```bash
   npm run dev
   # 前端将运行在 http://localhost:8000
   ```

3. **检查网络连接**
   - 打开浏览器开发者工具
   - 查看 Network 标签
   - 确认请求是否正确发送到后端

### 4.2 接口联调检查清单

#### ✅ 基础连接测试
- [ ] 后端服务正常运行（8080端口）
- [ ] 前端服务正常运行（8000端口）
- [ ] 代理配置生效
- [ ] 环境变量正确加载

#### ✅ 认证接口测试
- [ ] 登录接口 (`POST /api/auth/login`)
- [ ] 登出接口 (`POST /api/auth/logout`)
- [ ] Token 刷新接口 (`POST /api/auth/refresh`)
- [ ] 获取当前用户 (`GET /api/auth/me`)

#### ✅ 业务接口测试
- [ ] 宠物列表 (`GET /api/pets`)
- [ ] 宠物详情 (`GET /api/pets/:id`)
- [ ] 订单列表 (`GET /api/orders`)
- [ ] 订单详情 (`GET /api/orders/:id`)
- [ ] 疫苗记录 (`GET /api/vaccine-records`)
- [ ] 服务记录 (`GET /api/service-records`)

#### ✅ 聊天接口测试
- [ ] 创建会话 (`POST /api/chat/sessions`)
- [ ] 获取会话列表 (`GET /api/chat/sessions`)
- [ ] 发送消息 (`POST /api/chat/messages`)
- [ ] 获取消息历史 (`GET /api/chat/sessions/:id/messages`)

### 4.3 常见问题排查

#### 问题 1: 跨域错误 (CORS)
**症状**: 浏览器控制台显示 CORS 错误

**解决方案**:
- 后端需要配置 CORS 允许前端域名
- 或者使用 Vite 代理（推荐）

#### 问题 2: 404 Not Found
**症状**: 请求返回 404

**排查步骤**:
1. 检查后端路由是否正确
2. 检查代理配置路径是否匹配
3. 检查请求 URL 是否正确

#### 问题 3: 401 Unauthorized
**症状**: 请求返回 401

**排查步骤**:
1. 检查 Token 是否正确设置
2. 检查 Token 是否过期
3. 检查后端 Token 验证逻辑

#### 问题 4: 网络连接失败
**症状**: Network Error 或连接超时

**排查步骤**:
1. 确认后端服务是否启动
2. 检查端口是否正确（8080）
3. 检查防火墙设置
4. 检查代理配置

## 五、接口规范约定

### 5.1 请求格式

#### 请求头
```typescript
{
    'Content-Type': 'application/json',
    'Authorization': 'Bearer <token>', // 需要认证的接口
}
```

#### 请求体（POST/PUT）
```json
{
    "field1": "value1",
    "field2": "value2"
}
```

### 5.2 响应格式

#### 成功响应
```json
{
    "success": true,
    "data": {
        // 实际数据
    },
    "message": "操作成功"
}
```

#### 错误响应
```json
{
    "success": false,
    "error": "错误信息",
    "message": "详细错误描述"
}
```

#### HTTP 状态码
- `200`: 成功
- `201`: 创建成功
- `400`: 请求参数错误
- `401`: 未授权（需要登录）
- `403`: 禁止访问（权限不足）
- `404`: 资源不存在
- `500`: 服务器内部错误

### 5.3 分页格式

```json
{
    "success": true,
    "data": {
        "items": [...],
        "total": 100,
        "page": 1,
        "pageSize": 10,
        "totalPages": 10
    }
}
```

### 5.4 列表查询参数

```typescript
{
    page?: number;        // 页码，从1开始
    pageSize?: number;    // 每页数量
    sortBy?: string;      // 排序字段
    sortOrder?: 'asc' | 'desc';  // 排序方向
    keyword?: string;     // 搜索关键词
    // 其他筛选条件
}
```

## 六、接口联调测试用例

### 6.1 认证模块

#### 测试用例 1: 用户登录
```typescript
// 请求
POST /api/auth/login
{
    "username": "admin",
    "password": "123456"
}

// 期望响应
{
    "success": true,
    "data": {
        "accessToken": "eyJhbGc...",
        "refreshToken": "eyJhbGc...",
        "user": {
            "id": "1",
            "username": "admin",
            "fullName": "管理员",
            "roles": ["admin", "user"]
        }
    }
}
```

#### 测试用例 2: 获取当前用户
```typescript
// 请求
GET /api/auth/me
Headers: {
    "Authorization": "Bearer <token>"
}

// 期望响应
{
    "success": true,
    "data": {
        "id": "1",
        "username": "admin",
        "fullName": "管理员",
        "email": "admin@example.com",
        "roles": ["admin", "user"]
    }
}
```

### 6.2 宠物模块

#### 测试用例 3: 获取宠物列表
```typescript
// 请求
GET /api/pets?page=1&pageSize=10&type=dog

// 期望响应
{
    "success": true,
    "data": {
        "items": [
            {
                "id": "1",
                "name": "旺财",
                "breed": "金毛",
                "type": "dog",
                "gender": "male",
                "birthDate": "2020-01-01",
                "avatar": "..."
            }
        ],
        "total": 50,
        "page": 1,
        "pageSize": 10
    }
}
```

### 6.3 订单模块

#### 测试用例 4: 创建订单
```typescript
// 请求
POST /api/orders
{
    "petId": "1",
    "serviceName": "宠物洗护",
    "servicePrice": 100,
    "quantity": 1,
    "scheduledTime": "2024-01-15T10:00:00Z"
}

// 期望响应
{
    "success": true,
    "data": {
        "id": "ORDER0001",
        "orderNumber": "ORDER0001",
        "status": "pending",
        "totalAmount": 100,
        "createdAt": "2024-01-10T08:00:00Z"
    }
}
```

## 七、联调时间安排

### 第一阶段：基础连接（1天）
- [ ] 配置代理和环境变量
- [ ] 测试基础连接
- [ ] 解决跨域问题

### 第二阶段：认证模块（1-2天）
- [ ] 登录接口联调
- [ ] Token 刷新机制
- [ ] 权限验证

### 第三阶段：业务模块（3-5天）
- [ ] 宠物管理接口
- [ ] 订单管理接口
- [ ] 记录管理接口

### 第四阶段：聊天模块（2-3天）
- [ ] 会话管理接口
- [ ] 消息发送接口
- [ ] 流式响应处理

### 第五阶段：测试与优化（2-3天）
- [ ] 接口性能测试
- [ ] 错误处理优化
- [ ] 用户体验优化

## 八、注意事项

1. **接口版本管理**: 建议使用 `/api/v1/` 前缀，便于后续版本升级
2. **错误处理**: 统一错误响应格式，前端统一处理
3. **Token 管理**: 实现自动刷新机制，避免频繁登录
4. **请求防抖**: 对搜索等高频请求进行防抖处理
5. **数据缓存**: 合理使用缓存，减少不必要的请求
6. **日志记录**: 记录关键接口的请求和响应，便于排查问题

## 九、工具推荐

### 接口测试工具
- **Postman**: 功能强大的 API 测试工具
- **Apifox**: 国产 API 协作工具
- **Thunder Client**: VS Code 插件，轻量级 API 测试

### 调试工具
- **浏览器开发者工具**: Network 标签查看请求详情
- **React DevTools**: 查看组件状态和 Props
- **Redux DevTools**: 查看状态管理（如果使用）

## 十、后续优化建议

1. **接口文档**: 使用 Swagger/OpenAPI 生成接口文档
2. **Mock 数据**: 开发阶段使用 Mock 数据，不依赖后端
3. **类型生成**: 根据后端接口自动生成 TypeScript 类型
4. **请求重试**: 实现请求失败自动重试机制
5. **离线支持**: 考虑实现离线缓存和同步

