# 后端连接问题排查指南

## 问题现象

```
[vite] http proxy error: /api/v1/users/me
AggregateError [ECONNREFUSED]: 
    at internalConnectMultiple (node:net:1134:18)
    at afterConnectMultiple (node:net:1715:7)
```

## 原因分析

这个错误表示前端无法连接到后端服务器。可能的原因：

1. **后端服务器未启动** - 最常见的原因
2. **后端运行在不同的端口** - 不是 8080
3. **后端运行在不同的地址** - 不是 localhost
4. **防火墙或网络问题**

## 解决方案

### 1. 检查后端服务器是否运行

```bash
# 检查 8080 端口是否被占用
lsof -i :8080

# 或者使用 netstat (macOS/Linux)
netstat -an | grep 8080

# 或者使用 ss (Linux)
ss -tuln | grep 8080
```

### 2. 启动后端服务器

确保后端服务器运行在 `http://localhost:8080`

```bash
# 根据你的后端框架启动服务器
# 例如 FastAPI:
uvicorn main:app --host 0.0.0.0 --port 8080

# 或者 Spring Boot:
java -jar your-app.jar --server.port=8080
```

### 3. 修改代理配置（如果后端运行在其他端口）

如果后端运行在其他端口（例如 3000），修改 `vite.config.ts`:

```typescript
proxy: {
    '/api': {
        target: 'http://localhost:3000', // 修改为实际端口
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '/api'),
    }
}
```

### 4. 修改代理配置（如果后端运行在其他地址）

如果后端运行在其他地址（例如 `http://192.168.1.100:8080`），修改 `vite.config.ts`:

```typescript
proxy: {
    '/api': {
        target: 'http://192.168.1.100:8080', // 修改为实际地址
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '/api'),
    }
}
```

### 5. 测试后端连接

使用 curl 或 Postman 测试后端是否可访问：

```bash
# 测试后端健康检查接口（如果有）
curl http://localhost:8080/api/health

# 测试 API 接口
curl http://localhost:8080/api/v1/users/me
```

### 6. 检查后端 CORS 配置

确保后端允许来自 `http://localhost:8000` 的请求：

```python
# FastAPI 示例
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["http://localhost:8000"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

## 开发模式下的处理

当前代码已经添加了错误处理：

1. **代理层错误处理** - `vite.config.ts` 中已添加代理错误日志
2. **请求层错误处理** - `src/utils/request.ts` 中已添加连接错误处理
3. **服务层错误处理** - 认证服务已添加后端未运行时的静默处理

## 临时解决方案（仅开发环境）

如果暂时无法启动后端，可以：

1. **使用 Mock 数据** - 在开发环境中使用 Mock 服务
2. **禁用某些功能** - 暂时禁用需要后端的功能
3. **使用环境变量** - 通过环境变量控制是否使用真实 API

## 常见问题

### Q: 后端运行在 Docker 容器中怎么办？

A: 如果后端在 Docker 中，确保：
- 端口映射正确：`docker run -p 8080:8080 ...`
- 使用 `host.docker.internal` 或容器 IP 地址

### Q: 后端需要认证怎么办？

A: 确保：
- Token 已正确存储在 `localStorage.getItem('token')`
- 请求头中包含 `Authorization: Bearer <token>`
- 后端正确验证 Token

### Q: 代理不工作怎么办？

A: 尝试：
1. 重启 Vite 开发服务器
2. 清除浏览器缓存
3. 检查 `vite.config.ts` 配置是否正确
4. 查看 Vite 控制台的详细错误信息

## 验证修复

修复后，你应该看到：

1. ✅ 控制台不再显示 `ECONNREFUSED` 错误
2. ✅ 网络请求成功返回数据
3. ✅ 应用功能正常工作

如果问题仍然存在，请检查：
- 后端服务器日志
- 浏览器开发者工具的网络标签
- Vite 开发服务器的控制台输出

