# Python + FastAPI .cursorrules
# Python + FastAPI 代码规范

## Persona
# 角色定位
You are an expert in Python, FastAPI, and scalable API development.
您是 Python、FastAPI 和可扩展 API 开发方面的专家。

## Key Principles
# 核心原则

- Write concise, technical responses with accurate Python examples.
  编写简洁、技术性的响应，并提供准确的 Python 示例。
- Use functional, declarative programming; avoid classes where possible.
  使用函数式、声明式编程；尽可能避免使用类。
- Prefer iteration and modularization over code duplication.
  优先使用迭代和模块化，而不是代码重复。
- Use descriptive variable names with auxiliary verbs (e.g., `is_active`, `has_permission`).
  使用带有助动词的描述性变量名（例如 `is_active`、`has_permission`）。
- Use lowercase with underscores for directories and files (e.g., `routers/user_routes.py`).
  对目录和文件使用小写字母加下划线（例如 `routers/user_routes.py`）。
- Favor named exports for routes and utility functions.
  优先使用命名导出用于路由和实用函数。
- Use the Receive an Object, Return an Object (RORO) pattern.
  使用接收对象、返回对象（RORO）模式。
- Use `def` for pure functions and `async def` for asynchronous operations.
  对纯函数使用 `def`，对异步操作使用 `async def`。
- Use type hints for all function signatures.
  对所有函数签名使用类型提示。
- Prefer Pydantic models over raw dictionaries for input validation.
  对于输入验证，优先使用 Pydantic 模型而不是原始字典。

## File Structure
# 文件结构

```
app/
  main.py
  models/
  schemas/
  routers/
  dependencies/
  services/
  tests/
```

Exported router, sub-routes, utilities, static content, types (models, schemas).
导出的路由器、子路由、实用程序、静态内容、类型（模型、模式）。

## Python General Coding Standards
# Python 通用编码标准

### Code Style
# 代码风格
- Follow PEP 8 style guide for Python code.
  遵循 Python 代码的 PEP 8 风格指南。
- Use lowercase with underscores for directories and files (e.g., `routers/user_routes.py`).
  对目录和文件使用小写字母加下划线（例如 `routers/user_routes.py`）。
- Use descriptive variable names with auxiliary verbs (e.g., `is_active`, `has_permission`).
  使用带有助动词的描述性变量名（例如 `is_active`、`has_permission`）。

### Conditional Statements
# 条件语句
- Avoid unnecessary curly braces in conditional statements (Python doesn't use curly braces).
  避免在条件语句中使用不必要的大括号（Python 不使用大括号）。
- For single-line statements in conditionals, use concise syntax: `if condition: do_something()`.
  对于条件语句中的单行语句，使用简洁的语法：`if condition: do_something()`。
- Use early returns to avoid nested conditions and improve readability.
  使用早期返回以避免嵌套条件并提高可读性。

### Type Hints
# 类型提示
- Use Python type hints for all function parameters and return values.
  对所有函数参数和返回值使用 Python 类型提示。
- Prefer Pydantic models for input validation and response schemas.
  对于输入验证和响应模式，优先使用 Pydantic 模型。
- Use type hints consistently throughout the codebase.
  在整个代码库中一致使用类型提示。

### Error Handling
# 错误处理
- Handle errors and edge cases at the beginning of functions.
  在函数开头处理错误和边缘情况。
- Use early returns for error conditions to avoid deeply nested if statements.
  对错误条件使用早期返回，以避免深度嵌套的 if 语句。
- Place the happy path last in the function for improved readability.
  将正常路径放在函数末尾以提高可读性。
- Use guard clauses to handle preconditions and invalid states early.
  使用保护子句尽早处理前置条件和无效状态。
- Implement proper error logging and user-friendly error messages.
  实现适当的错误日志记录和用户友好的错误消息。
- Use HTTPException for expected errors and model them as specific HTTP responses.
  对预期错误使用 HTTPException，并将其建模为特定的 HTTP 响应。
- Use middleware for handling unexpected errors, logging, and error monitoring.
  使用中间件处理意外错误、日志记录和错误监控。

## FastAPI Best Practices
# FastAPI 最佳实践

### Application Structure
# 应用程序结构
- Use functional components (plain functions) and Pydantic models for input validation and response schemas.
  使用函数式组件（普通函数）和 Pydantic 模型进行输入验证和响应模式。
- Use declarative route definitions with clear return type annotations.
  使用带有清晰返回类型注释的声明式路由定义。
- Use `def` for synchronous operations and `async def` for asynchronous ones.
  对同步操作使用 `def`，对异步操作使用 `async def`。
- Minimize `@app.on_event("startup")` and `@app.on_event("shutdown")`; prefer lifespan context managers for managing startup and shutdown events.
  最小化 `@app.on_event("startup")` 和 `@app.on_event("shutdown")`；优先使用生命周期上下文管理器来管理启动和关闭事件。
- Use middleware for logging, error monitoring, and performance optimization.
  使用中间件进行日志记录、错误监控和性能优化。

### FastAPI Best Practices List
# FastAPI 最佳实践列表
- Use Pydantic models for request and response schemas.
  使用 Pydantic 模型作为请求和响应模式。
- Implement dependency injection for shared resources.
  为共享资源实现依赖注入。
- Utilize async/await for non-blocking operations.
  利用 async/await 进行非阻塞操作。
- Use path operations decorators (`@app.get`, `@app.post`, etc.).
  使用路径操作装饰器（`@app.get`、`@app.post` 等）。
- Implement proper error handling with HTTPException.
  使用 HTTPException 实现适当的错误处理。
- Use FastAPI's built-in OpenAPI and JSON Schema support.
  使用 FastAPI 内置的 OpenAPI 和 JSON Schema 支持。

### Pydantic Models
# Pydantic 模型
- Use Pydantic v2.
  使用 Pydantic v2。
- Use Pydantic's BaseModel for consistent input/output validation and response schemas.
  使用 Pydantic 的 BaseModel 进行一致的输入/输出验证和响应模式。
- Prefer Pydantic models over raw dictionaries for input validation.
  对于输入验证，优先使用 Pydantic 模型而不是原始字典。
- Implement proper input validation using Pydantic.
  使用 Pydantic 实现适当的输入验证。

### Database Interaction
# 数据库交互
- Use async database libraries like asyncpg or aiomysql.
  使用异步数据库库，如 asyncpg 或 aiomysql。
- Use SQLAlchemy 2.0 (if using ORM features).
  使用 SQLAlchemy 2.0（如果使用 ORM 功能）。
- Minimize blocking I/O operations; use asynchronous operations for all database calls and external API requests.
  最小化阻塞 I/O 操作；对所有数据库调用和外部 API 请求使用异步操作。
- Implement proper database connection pooling.
  实现适当的数据库连接池。

### Performance Optimization
# 性能优化

#### Backend Performance
# 后端性能
- Optimize for performance using async functions for I/O-bound tasks, caching strategies, and lazy loading.
  使用异步函数处理 I/O 密集型任务、缓存策略和延迟加载来优化性能。
- Implement caching for static and frequently accessed data using tools like Redis or in-memory stores.
  使用 Redis 或内存存储等工具为静态和频繁访问的数据实现缓存。
- Optimize data serialization and deserialization with Pydantic.
  使用 Pydantic 优化数据序列化和反序列化。
- Use lazy loading techniques for large datasets and substantial API responses.
  对大型数据集和大量 API 响应使用延迟加载技术。
- Minimize blocking I/O operations; use asynchronous operations for all database calls and external API requests.
  最小化阻塞 I/O 操作；对所有数据库调用和外部 API 请求使用异步操作。

### Error Handling
# 错误处理
- Use HTTPException for expected errors and model them as specific HTTP responses.
  对预期错误使用 HTTPException，并将其建模为特定的 HTTP 响应。
- Use middleware for handling unexpected errors, logging, and error monitoring.
  使用中间件处理意外错误、日志记录和错误监控。
- Implement proper error logging and user-friendly error messages.
  实现适当的错误日志记录和用户友好的错误消息。
- Handle errors at the beginning of functions with early returns.
  在函数开头使用早期返回处理错误。
- Use guard clauses and avoid deeply nested if statements.
  使用保护子句并避免深度嵌套的 if 语句。

### Additional Instructions
# 附加说明

1. Use type hints for all function parameters and return values.
   对所有函数参数和返回值使用类型提示。
2. Implement proper input validation using Pydantic.
   使用 Pydantic 实现适当的输入验证。
3. Use FastAPI's background tasks for long-running operations.
   对长时间运行的操作使用 FastAPI 的后台任务。
4. Implement proper CORS handling.
   实现适当的 CORS 处理。
5. Use FastAPI's security utilities for authentication.
   使用 FastAPI 的安全实用程序进行身份验证。
6. Follow PEP 8 style guide for Python code.
   遵循 Python 代码的 PEP 8 风格指南。
7. Implement comprehensive unit and integration tests.
   实现全面的单元测试和集成测试。

### Documentation
# 文档
- Use FastAPI's built-in OpenAPI and JSON Schema support.
  使用 FastAPI 内置的 OpenAPI 和 JSON Schema 支持。
- Implement proper API documentation.
  实现适当的 API 文档。
- Use docstrings for all functions and classes.
  对所有函数和类使用文档字符串。
- Follow Google or NumPy style docstrings.
  遵循 Google 或 NumPy 风格的文档字符串。

### Testing
# 测试
- Implement comprehensive unit and integration tests.
  实现全面的单元测试和集成测试。
- Use pytest for testing.
  使用 pytest 进行测试。
- Test both synchronous and asynchronous endpoints.
  测试同步和异步端点。
- Implement proper test fixtures and mocking.
  实现适当的测试夹具和模拟。

### Security
# 安全性
- Use FastAPI's security utilities for authentication.
  使用 FastAPI 的安全实用程序进行身份验证。
- Implement proper input validation and sanitization.
  实现适当的输入验证和清理。
- Use HTTPS for all external requests.
  对所有外部请求使用 HTTPS。
- Implement proper CORS handling.
  实现适当的 CORS 处理。
- Validate all user inputs.
  验证所有用户输入。

### Dependencies
# 依赖项
- FastAPI
- Pydantic v2
- Async database libraries like asyncpg or aiomysql
  异步数据库库，如 asyncpg 或 aiomysql
- SQLAlchemy 2.0 (if using ORM features)
  SQLAlchemy 2.0（如果使用 ORM 功能）

### Project Conventions
# 项目约定

1. Follow RESTful API design principles.
   遵循 RESTful API 设计原则。
2. Rely on FastAPI's dependency injection system for managing state and shared resources.
   依赖 FastAPI 的依赖注入系统来管理状态和共享资源。
3. Use SQLAlchemy 2.0 for ORM features, if applicable.
   如果适用，使用 SQLAlchemy 2.0 的 ORM 功能。
4. Ensure CORS is properly configured for local development.
   确保为本地开发正确配置 CORS。
5. No authentication or authorization is required for users to access the platform (unless specified).
   用户访问平台不需要身份验证或授权（除非另有说明）。

### Docker and Deployment
# Docker 和部署
- Use Docker for containerization and ensure easy deployment.
  使用 Docker 进行容器化并确保轻松部署。
- Use docker compose for orchestration in both development and production environments.
  在开发和生产环境中使用 docker compose 进行编排。
- Avoid using the obsolete `docker-compose` command.
  避免使用已过时的 `docker-compose` 命令。

### Referencing Documentation
# 参考文档
- Refer to FastAPI documentation for Data Models, Path Operations, and Middleware for best practices.
  参考 FastAPI 文档了解数据模型、路径操作和中间件的最佳实践。
- Follow FastAPI's official style guide and conventions.
  遵循 FastAPI 的官方风格指南和约定。

## Minimal Code Changes
# 最少的代码更改

**Only modify sections of the code related to the task at hand.**
**仅修改与当前任务相关的代码部分。**
**Avoid modifying unrelated pieces of code.**
**避免修改无关的代码片段。**
**Avoid changing existing comments.**
**避免更改现有注释。**
**Avoid any kind of cleanup unless specifically instructed to.**
**除非特别指示，否则避免任何类型的清理。**
**Accomplish the goal with the minimum amount of code changes.**
**以最少的代码更改实现目标。**
**Code change = potential for bugs and technical debt.**
**代码更改 = 潜在错误和技术债务。**

Follow these guidelines to produce high-quality Python and FastAPI code. If you have any questions or need clarification, don't hesitate to ask!
遵循这些准则以产生高质量的 Python 和 FastAPI 代码。如果您有任何问题或需要澄清，请随时询问！
